<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多人聊天室</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.11/vue.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        input {
            margin: 5px;
        }

        ul {
            list-style: none;
            padding: 0;
        }

        li {
            margin-bottom: 10px;
        }

        h4 span {
            font-weight: normal;
            font-size: 0.9em;
            color: gray;
        }
    </style>
</head>

<body>
    <div id="app">
        <ul>
            <li v-for="m in messages">
                <h4>{{ m.message }} <span>-- {{ m.name }}</span></h4>
            </li>
        </ul>

        <div v-if="typing">輸入中...</div>
        <br>

        <input v-model="temp.message" placeholder="訊息"
               @keydown.enter="sendMessage"
               @input="sendTyping" />
        <input v-model="temp.name" placeholder="你是誰？" />
        <button @click="sendMessage">送出</button>
    </div>

    <script>
        new Vue({
            el: "#app",
            data: {
                messages: [],
                temp: {
                    name: "",
                    message: ""
                },
                socket: null,
                typing: false
            },
            mounted() {
                // 連接到 Socket.io 伺服器
                this.socket = io("http://localhost:4040");

                // 取得歷史訊息
                this.socket.on("allMessage", obj => {
                    console.log('收到所有歷史訊息', obj);
                    this.messages = obj;
                });

                // 有新訊息
                this.socket.on("newMessage", obj => {
                    console.log('收到新訊息', obj);
                    this.messages.push(obj);
                });

                // 有人正在輸入
                this.socket.on("someoneIsTyping", value => {
                    this.typing = value;
                });
            },
            methods: {
                sendMessage() {
                    if (this.temp.name && this.temp.message) {
                        this.socket.emit("sendMessage", {
                            name: this.temp.name,
                            message: this.temp.message
                        });
                        this.temp.message = "";
                    }
                },
                sendTyping() {
                    if (this.temp.name) {
                        this.socket.emit("sendTyping");
                    }
                }
            }
        });
    </script>
</body>

</html>
